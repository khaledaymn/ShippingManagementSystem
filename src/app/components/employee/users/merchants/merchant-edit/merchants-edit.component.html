<div class="merchants-edit-container">
  <!-- Form Header -->
  <div class="form-header">
    <h2>{{ isEditMode ? "Edit Merchant" : "Add New Merchant" }}</h2>
    <button (click)="onCancel()" class="back-button" [disabled]="isLoading">
      <i class="bi bi-x-circle"></i> Cancel
    </button>
  </div>

  <!-- Alerts -->
  <div *ngIf="isLoading" class="alert alert-info">
    <i class="bi bi-hourglass-split"></i> Loading merchant data...
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger">
    <i class="bi bi-exclamation-triangle-fill"></i> {{ errorMessage }}
  </div>
  <div *ngIf="successMessage" class="alert alert-success">
    <i class="bi bi-check-circle-fill"></i> {{ successMessage }}
  </div>

  <!-- Merchant Form -->
  <form
    [formGroup]="merchantForm"
    (ngSubmit)="onSubmit()"
    class="merchant-form"
    novalidate
  >
    <!-- Basic Information Section -->
    <div class="form-section">
      <h4 class="section-title">Basic Information</h4>
      <div class="form-row">
        <div class="form-group full-width">
          <label for="name">
            <i class="bi bi-person-fill"></i> Full Name
            <span class="required">*</span>
          </label>
          <input
            id="name"
            type="text"
            formControlName="name"
            class="form-control"
            placeholder="Enter merchant name"
            maxlength="100"
          />
          <div *ngIf="isFieldInvalid('name')" class="validation-error">
            {{ getFieldError("name") }}
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="email">
            <i class="bi bi-envelope-fill"></i> Email Address
            <span class="required">*</span>
          </label>
          <input
            id="email"
            type="email"
            formControlName="email"
            class="form-control"
            placeholder="Enter email address"
          />
          <div *ngIf="isFieldInvalid('email')" class="validation-error">
            {{ getFieldError("email") }}
          </div>
        </div>
        <div class="form-group">
          <label for="phoneNumber">
            <i class="bi bi-telephone-fill"></i> Phone Number
            <span class="required">*</span>
          </label>
          <input
            id="phoneNumber"
            type="tel"
            formControlName="phoneNumber"
            class="form-control"
            placeholder="Enter phone number"
          />
          <div *ngIf="isFieldInvalid('phoneNumber')" class="validation-error">
            {{ getFieldError("phoneNumber") }}
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label for="address">
            <i class="bi bi-geo-alt-fill"></i> Address
            <span class="required">*</span>
          </label>
          <textarea
            id="address"
            formControlName="address"
            class="form-control"
            rows="3"
            placeholder="Enter full address"
            maxlength="200"
          ></textarea>
          <div *ngIf="isFieldInvalid('address')" class="validation-error">
            {{ getFieldError("address") }}
          </div>
        </div>
      </div>

      <ng-container *ngIf="!isEditMode">
        <div class="form-row">
          <div class="form-group">
            <label for="password">
              <i class="bi bi-lock-fill"></i> Password
              <span class="required">*</span>
            </label>
            <input
              id="password"
              type="password"
              formControlName="password"
              class="form-control"
              placeholder="Enter password"
            />
            <div *ngIf="isFieldInvalid('password')" class="validation-error">
              {{ getFieldError("password") }}
            </div>
            <small class="form-text text-muted">
              Password must contain at least 8 characters with uppercase, lowercase, number, and special character
            </small>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Store Information Section -->
    <div class="form-section">
      <h4 class="section-title">Store Information</h4>
      <div class="form-row">
        <div class="form-group">
          <label for="storeName">
            <i class="bi bi-shop"></i> Store Name
            <span class="required">*</span>
          </label>
          <input
            id="storeName"
            type="text"
            formControlName="storeName"
            class="form-control"
            placeholder="Enter store name"
            maxlength="100"
          />
          <div *ngIf="isFieldInvalid('storeName')" class="validation-error">
            {{ getFieldError("storeName") }}
          </div>
        </div>
        <div class="form-group">
          <label for="rejectedOrderPercent">
            <i class="bi bi-percent"></i> Rejected Order Percentage
            <span class="required">*</span>
          </label>
          <div class="input-group">
            <input
              id="rejectedOrderPercent"
              type="number"
              formControlName="rejectedOrderPercent"
              class="form-control"
              min="0"
              max="100"
              placeholder="0"
            />
            <span class="input-group-text">%</span>
          </div>
          <div *ngIf="isFieldInvalid('rejectedOrderPercent')" class="validation-error">
            {{ getFieldError("rejectedOrderPercent") }}
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="specialPickup">
            <i class="bi bi-currency-dollar"></i> Special Pickup Price
          </label>
          <div class="input-group">
            <input
              id="specialPickup"
              type="number"
              formControlName="specialPickup"
              class="form-control"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
            <span class="input-group-text">$</span>
          </div>
          <div *ngIf="isFieldInvalid('specialPickup')" class="validation-error">
            {{ getFieldError("specialPickup") }}
          </div>
        </div>
        <div class="form-group">
          <label for="branchIds">
            <i class="bi bi-building"></i> Assigned Branches
          </label>
          <select
            id="branchIds"
            formControlName="branchIds"
            multiple
            class="form-control select-multiple"
            [disabled]="branches.length === 0"
            title="Assigned Branches"
          >
            <option value="" disabled>
              {{ branches.length === 0 ? "Loading branches..." : "Select branches" }}
            </option>
            <option *ngFor="let branch of branches" [value]="branch.id">
              {{ branch.name }} - {{ branch.cityName }}
            </option>
          </select>
          <small class="form-text text-muted">
            Hold Ctrl/Cmd to select multiple branches
          </small>
        </div>
      </div>
    </div>

    <!-- Special Delivery Prices Section -->
    <div class="form-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="section-title mb-0">Special Delivery Prices</h4>
        <button
          type="button"
          class="btn btn-outline-primary btn-sm"
          (click)="addSpecialDeliveryPrice()"
        >
          <i class="bi bi-plus"></i> Add Price
        </button>
      </div>

      <div *ngIf="specialDeliveryPricesArray.length === 0" class="text-muted text-center py-3">
        No special delivery prices configured
      </div>

      <div
        *ngFor="let priceGroup of specialDeliveryPricesArray.controls; let i = index"
        class="special-price-item"
        [formGroup]="priceGroup"
      >
        <div class="form-row">
          <div class="form-group">
            <label [for]="'cityId-' + i">
              <i class="bi bi-geo-alt"></i> City
              <span class="required">*</span>
            </label>
            <select
              [id]="'cityId-' + i"
              formControlName="cityId"
              class="form-control"
              [disabled]="cities.length === 0"
              title="City"
            >
              <option value="">
                {{ cities.length === 0 ? "Loading cities..." : "Select city" }}
              </option>
              <option *ngFor="let city of cities" [value]="city.id">
                {{ city.name }}
              </option>
            </select>
            <div *ngIf="priceGroup.get('cityId')?.invalid && priceGroup.get('cityId')?.touched" class="validation-error">
              City is required
            </div>
          </div>
          <div class="form-group">
            <label [for]="'specialPrice-' + i">
              <i class="bi bi-currency-dollar"></i> Special Price
              <span class="required">*</span>
            </label>
            <div class="input-group">
              <input
                [id]="'specialPrice-' + i"
                type="number"
                formControlName="specialPrice"
                class="form-control"
                min="0"
                step="0.01"
                placeholder="0.00"
              />
              <span class="input-group-text">$</span>
            </div>
            <div *ngIf="priceGroup.get('specialPrice')?.invalid && priceGroup.get('specialPrice')?.touched" class="validation-error">
              Special price must be at least 0
            </div>
          </div>
          <div class="form-group align-self-end">
            <button
              type="button"
              class="btn btn-outline-danger btn-sm w-100"
              (click)="removeSpecialDeliveryPrice(i)"
            >
              <i class="bi bi-trash"></i> Remove
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button
        type="submit"
        [disabled]="merchantForm.invalid || isLoading"
        class="btn btn-primary"
      >
        <i class="bi bi-save"></i>
        <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
        {{ isEditMode ? "Update Merchant" : "Create Merchant" }}
      </button>
    </div>
  </form>
</div>
