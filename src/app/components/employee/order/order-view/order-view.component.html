<div class="orders-view-container">
  <app-notification></app-notification>

  <!-- Action Bar -->
  <div class="action-bar" [class.no-action-left]="!canCreate">
    <div class="action-left" *ngIf="canCreate">
      <button class="btn btn-primary" (click)="onAdd()" [disabled]="loading">
        <i class="bi bi-plus-circle"></i>
        Add New Order
      </button>
    </div>
    <div class="action-right" [class.no-action-left-right]="!canCreate">
      <button type="button" class="btn btn-outline-secondary" (click)="printAllOrders()" [disabled]="loading || orders.length === 0">
        <i class="bi bi-printer me-2"></i>
        Print All Orders
      </button>
      <button class="btn btn-outline-secondary" (click)="onExport()" [disabled]="loading">
        <i class="bi bi-download"></i>
        Export
      </button>
      <button class="btn btn-outline-secondary" (click)="refreshData()" [disabled]="loading">
        <i class="bi bi-arrow-clockwise"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-card">
    <app-table
      [config]="tableConfig"
      [data]="tableData"
      [loading]="loading"
      [error]="error"
      title="Orders Management"
      subtitle="Manage orders and their status"
      (tableEvent)="onTableEvent($event)"
    ></app-table>
  </div>

  <!-- Change Status Modal -->
  <div class="modal fade" [class.show]="showChangeStatusModal" [style.display]="showChangeStatusModal ? 'block' : 'none'" tabindex="-1" *ngIf="showChangeStatusModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Order Status</h5>
          <button type="button" class="btn-close" (click)="closeChangeStatusModal()"
          aria-label="Close"></button>
        </div>
        <form [formGroup]="changeStatusForm" (ngSubmit)="onChangeStatus()">
          <div class="modal-body">
            <div class="mb-3" *ngIf="selectedOrder">
              <h6>Order Information</h6>
              <p><strong>Order ID:</strong> #{{ selectedOrder.id }}</p>
              <p><strong>Customer:</strong> {{ selectedOrder.customerName }}</p>
              <p><strong>Current Status:</strong> {{ formatOrderStatus(selectedOrder.orderState) }}</p>
            </div>

            <div class="mb-3">
              <label for="orderState" class="form-label">New Status *</label>
              <select class="form-select" id="orderState" formControlName="orderState" required>
                <option value="">Select Status</option>
                <option *ngFor="let option of orderStateOptions" [value]="option.value" [disabled]="selectedOrder?.orderState === 'New' && option.value !== 'Pendding' && option.value !== 'New'">
                  {{ option.label }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="changeStatusForm.get('orderState')?.invalid && changeStatusForm.get('orderState')?.touched">
                Please select a status.
              </div>
            </div>

            <div class="mb-3">
              <label for="notes" class="form-label">Notes</label>
              <textarea class="form-control" id="notes" formControlName="notes" rows="3" placeholder="Optional notes about the status change"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeChangeStatusModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="changeStatusForm.invalid || loading">
              <span class="spinner-border spinner-border-sm me-2" *ngIf="loading"></span>
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Assign Delivery Modal -->
  <div class="modal fade" [class.show]="showAssignDeliveryModal" [style.display]="showAssignDeliveryModal ? 'block' : 'none'" tabindex="-1" *ngIf="showAssignDeliveryModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Assign to Delivery</h5>
          <button type="button" class="btn-close" (click)="closeAssignDeliveryModal()"
          aria-label="Close"></button>
        </div>
        <form [formGroup]="assignDeliveryForm" (ngSubmit)="onAssignDelivery()">
          <div class="modal-body">
            <div class="mb-3" *ngIf="selectedOrder">
              <h6>Order Information</h6>
              <p><strong>Order ID:</strong> #{{ selectedOrder.id }}</p>
              <p><strong>Customer:</strong> {{ selectedOrder.customerName }}</p>
              <p><strong>Address:</strong> {{ selectedOrder.villageAndStreet }}</p>
            </div>

            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              Assigning this order will automatically change its status to "Delivered to Representative".
            </div>

            <div class="mb-3">
              <label for="shippingRepresentativeId" class="form-label">Shipping Representative *</label>
              <select class="form-select" id="shippingRepresentativeId" formControlName="shippingRepresentativeId" required>
                <option value="">Select Representative</option>
                <option *ngFor="let option of shippingRepresentativeOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="assignDeliveryForm.get('shippingRepresentativeId')?.invalid && assignDeliveryForm.get('shippingRepresentativeId')?.touched">
                Please select a shipping representative.
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeAssignDeliveryModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="assignDeliveryForm.invalid || loading">
              <span class="spinner-border spinner-border-sm me-2" *ngIf="loading"></span>
              Assign Order
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop fade show" *ngIf="showChangeStatusModal || showAssignDeliveryModal"></div>

  <!-- Confirmation Dialog -->
  <app-confirmation-dialog
    [show]="showConfirmDialog"
    [data]="dialogData"
    [loading]="loading"
    (confirmed)="onConfirmDelete()"
    (cancelled)="onCancelDelete()"
  ></app-confirmation-dialog>
</div>
